---
description: 
globs: 
alwaysApply: false
---
âœ… No inline scripts inside codemagic.yaml

âœ… All custom logic lives inside main.sh or other shell scripts inside a workflow-specific folder

âœ… Only script calls are placed in codemagic.yaml

âœ… Extensible and clean for team or multi-environment use

âœ… Cursor Rules for Codemagic Custom Code Injection
Hereâ€™s a convention you can follow, suitable for teams and Cursor-style cleanliness:

ğŸ“ Folder Structure
css
Copy
Edit
/
â”œâ”€â”€ codemagic.yaml
â”œâ”€â”€ workflows/
â”‚   â””â”€â”€ ios-app/
â”‚       â”œâ”€â”€ main.sh
â”‚       â”œâ”€â”€ fix_embedding_ruby.sh
â”‚       â”œâ”€â”€ fix_embedding_sed.sh
â”‚       â””â”€â”€ scripts/
â”‚           â””â”€â”€ fix_framework_embedding.rb
âœ… codemagic.yaml (Clean Script Invocation Only)
yaml
Copy
Edit
workflows:
  ios-app:
    name: iOS Build Workflow
    instance_type: mac_mini_m1
    environment:
      vars:
        WORKFLOW_DIR: workflows/ios-app
        XCODE_WORKSPACE: "ios/Runner.xcworkspace"
        XCODE_SCHEME: "Runner"
    scripts:
      - name: Run iOS workflow main script
        script: |
          bash $WORKFLOW_DIR/main.sh
    artifacts:
      - build/ios/ipa/*.ipa
      - /tmp/xcodebuild_logs/*.log
âœ… workflows/ios-app/main.sh
bash
Copy
Edit
#!/bin/bash
set -e

echo "ğŸ“¦ Getting Flutter packages..."
flutter packages pub get

# Choose one of the following based on your strategy
echo "ğŸ”§ Fixing framework embedding with Ruby method..."
bash "$(dirname "$0")/fix_embedding_ruby.sh"

# If you want sed instead, comment above and uncomment below:
# echo "ğŸ”§ Fixing framework embedding with sed method..."
# bash "$(dirname "$0")/fix_embedding_sed.sh"

echo "ğŸš€ Building iOS app..."
xcode-project build-ipa --workspace "$XCODE_WORKSPACE" --scheme "$XCODE_SCHEME"
âœ… workflows/ios-app/fix_embedding_ruby.sh
bash
Copy
Edit
#!/bin/bash
set -e

echo "ğŸ“¦ Installing Ruby gem xcodeproj..."
gem install xcodeproj

echo "ğŸš§ Running Ruby script to fix embedding..."
ruby "$(dirname "$0")/scripts/fix_framework_embedding.rb"
âœ… workflows/ios-app/fix_embedding_sed.sh
bash
Copy
Edit
#!/bin/bash
set -e

TARGET_NAME="YourExtensionName"  # <-- Change this
PROJECT_FILE="ios/Runner.xcodeproj/project.pbxproj"

echo "ğŸ” Running sed to patch $TARGET_NAME for Flutter.xcframework..."
sed -i '' "/\/\* Flutter.xcframework in Embed Frameworks \*\//,/attributes = \([^)]+\)/s/ATTRIBUTES = ([^)]*);/ATTRIBUTES = (CodeSignOnCopy, RemoveHeadersOnCopy);/" "$PROJECT_FILE"

echo "âœ… Sed patch complete"
âœ… workflows/ios-app/scripts/fix_framework_embedding.rb
Same as before â€” ensure it's executable and correctly references the YourExtensionName target.